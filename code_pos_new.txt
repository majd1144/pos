create database pos;
use pos;

------------------------------------------TABLES-------------------------------------------------------------------------------
create table employee
(
employeeID int primary key identity(1,1) ,
firstName  nvarchar(20) not null,
lastName   nvarchar(20) not null,
phone      nvarchar(15) not null,
userName   nvarchar(20) not null,
password   nvarchar(20) not null,
Role       nvarchar(20) not null,
isActive   bit          not null
);

create table customer
(
customerID int primary key identity(100,1),
firstName  nvarchar(20) ,
lastName   nvarchar(20) ,
phone      nvarchar(15) ,
email      nvarchar(50) ,
gender     nvarchar(10) ,
createdAT  DATETIME2    ,
birthDate  date         ,
city       nvarchar(50) ,
isActive   bit 
);
create table category
(
categoryID int primary key identity(1,1) ,
categoryName nvarchar(50) not null
);
create table systemSettings
(
settingID int primary key identity(1,1) ,
settingName nvarchar(50) not null,
settingValue nvarchar(20) not null
);
create table payments
(
paymentID int primary key identity(1,1) ,
orderID int not null foreign key references [order](orderID) ,
paymentType nvarchar(20) not null,
paymentAmount DECIMAL(10,3) not null,
PaymentDate DATETIME2  not null  
);
create table discountDetails
(
discountID int primary key identity(1,1) ,
discountType     nvarchar(30) not null,
value  int not null,
valueType nvarchar(10) not null,
startDate date not null,
endDate	date not null,
isActive   bit not null
);
create table products
(
ProductID int primary key identity(1,1) ,
categoryID	int not null foreign key references category(categoryID) ,
ProductName nvarchar(10) not null,
ProductDescription nvarchar(50) not null,
ProductTax	  decimal(5,2) not null,
ProductPrice  decimal(7,2) not null,
ProductTotal as ( ProductPrice + ( ProductPrice * ProductTax / 100)) persisted
);
create table discountPermissions
(
discountNumber int primary key identity(1,1) ,
discountID  int not null foreign key references discountDetails(discountID) ,
customerID	 int foreign key references customer(customerID) ,
employeeID	 int foreign key references employee(employeeID) ,
productID   int foreign key references products(productID)  
);
create table [order]
(
orderID int primary key identity(1,1) ,
employeeID int not null foreign key references employee(employeeID) ,
orderDate dateTime2    not null,
OrderStatus nvarchar(20) not null,
customerID	 int foreign key references customer(customerID) ,
orderTotal	decimal(7,2) not null,
discountID	int  foreign key references discountDetails(discountID) ,
discountAmount decimal(10,2) default 0 ,
netTotal    decimal(7,2) not null 
);
create table OrderDetails (
    OrderDetailsID int primary key identity(1,1) ,
    orderID int not null foreign key references [order](orderID) ,
    productID   int foreign key references products(productID)  ,
    quantity int not null check (quantity > 0),
    
    ProductPrice decimal(7,2) not null, 
    ProductTax decimal(5,2) not null,  

    ProductTotal as(quantity * (ProductPrice + (ProductPrice * ProductTax / 100))) persisted,

    discountID  int  null foreign key references discountDetails(discountID) ,
    DiscountAmount   decimal(10,2)  ,

    ProductNet as (
       case
            when DiscountAmount is null then quantity * (ProductPrice + (ProductPrice * ProductTax / 100))
            else quantity * (ProductPrice + (ProductPrice * ProductTax / 100)) - (DiscountAmount)
     end            
    ) persisted
);

-----------------------------------------------------triggers--------------------------------------------------------
CREATE TRIGGER  trg_FillDiscountAmountnew5
ON OrderDetails
AFTER INSERT
AS
BEGIN
    UPDATE od
    SET od.DiscountAmount = 
        CASE 
            WHEN dd.valueType = 'percent' 
                THEN (dd.value / 100.0) * ((od.ProductPrice + (od.ProductPrice * ISNULL(od.ProductTax, 0) / 100.0)) * od.quantity)
            ELSE dd.value * od.quantity    
        END
    FROM OrderDetails od
    JOIN inserted i ON od.OrderDetailsID = i.OrderDetailsID
    JOIN discountDetails dd ON od.discountID = dd.discountID
    JOIN [order] o ON od.orderID = o.orderID

    WHERE od.discountID IS NOT NULL
      AND (
            NOT EXISTS (
                SELECT 1 FROM discountPermissions dp
                WHERE dp.discountID = od.discountID
                  AND (dp.customerID IS NOT NULL OR dp.employeeID IS NOT NULL OR dp.productID IS NOT NULL)
            )

            
         OR EXISTS (
    SELECT 1 FROM discountPermissions dp
    WHERE dp.discountID = od.discountID
      AND dp.productID = od.productID
      AND dp.employeeID IS NULL 
      AND dp.customerID IS NULL
)
OR EXISTS (
                SELECT 1 FROM discountPermissions dp
                WHERE dp.discountID = od.discountID
                  AND dp.employeeID = o.employeeID
                  AND dp.productID IS NULL
                  AND dp.customerID IS NULL
            )
            OR EXISTS (
                SELECT 1 FROM discountPermissions dp
                WHERE dp.discountID = od.discountID
                  AND dp.customerID = o.customerID
                  AND dp.productID IS NULL
                  AND dp.employeeID IS NULL
            )
        );
END;


CREATE TRIGGER trg_UpdateOrderTotal_GroupBy
ON OrderDetails
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    UPDATE o
    SET o.orderTotal = ISNULL(odTotals.TotalProductTotal, 0)
    FROM [order] o
    LEFT JOIN (
        SELECT orderID, SUM(ProductTotal) AS TotalProductTotal
        FROM OrderDetails
        GROUP BY orderID
    ) odTotals ON o.orderID = odTotals.orderID
    WHERE o.orderID IN (
        SELECT orderID FROM inserted
        UNION
        SELECT orderID FROM deleted
    );
END;

CREATE TRIGGER trg_UpdateOrderNetTotal
ON OrderDetails
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    UPDATE o
    SET o.netTotal = ISNULL(sub.TotalNet, 0)
    FROM [order] o
    INNER JOIN (
        SELECT od.orderID, SUM(od.ProductNet) AS TotalNet
        FROM OrderDetails od
        GROUP BY od.orderID
    ) sub ON o.orderID = sub.orderID
    WHERE o.orderID IN (
        SELECT orderID FROM inserted
        UNION
        SELECT orderID FROM deleted
    );
END;
CREATE TRIGGER trg_UpdateOrderDiscountAmount
ON OrderDetails
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    UPDATE o
    SET o.discountAmount = ISNULL(od.DiscountTotal, 0)
    FROM [order] o
    INNER JOIN (
        SELECT orderID, SUM(DiscountAmount) AS DiscountTotal
        FROM OrderDetails
        GROUP BY orderID
    ) od ON o.orderID = od.orderID
    WHERE o.orderID IN (
        SELECT orderID FROM inserted
        UNION
        SELECT orderID FROM deleted
    );
END;
CREATE TRIGGER trg_UpdateOrderStatusAfterPayment
ON Payments
AFTER INSERT
AS
BEGIN
    UPDATE o
    SET o.OrderStatus = 'Paid'
    FROM [Order] o
    INNER JOIN inserted i ON o.OrderID = i.OrderID
END
CREATE TRIGGER trg_FillProductInfo
ON OrderDetails
AFTER INSERT
AS
BEGIN
    UPDATE od
    SET 
        od.ProductPrice = p.ProductPrice,
        od.ProductTax = p.ProductTax
    FROM OrderDetails od
    JOIN inserted i ON od.OrderDetailsID = i.OrderDetailsID
    JOIN Products p ON i.ProductID = p.ProductID;
END;

---------------
































-----------------
INSERT INTO [order] (employeeID, orderDate, OrderStatus, customerID, orderTotal, discountID, discountAmount, netTotal)
VALUES (1, '2025-07-19 16:01:20', 'Completed', 100, 50.0, 1, 5.0, 45.0);

INSERT INTO [order] (employeeID, orderDate, OrderStatus, customerID, orderTotal, discountID, discountAmount, netTotal)
VALUES (2, '2025-07-19 16:01:20', 'Pending', 101, 100.0, 2, 10.0, 90.0);

INSERT INTO [order] (employeeID, orderDate, OrderStatus, customerID, orderTotal, discountID, discountAmount, netTotal)
VALUES (3, '2025-07-19 16:01:20', 'Completed', 102, 80.0, 3, 8.0, 72.0);

INSERT INTO [order] (employeeID, orderDate, OrderStatus, customerID, orderTotal, discountID, discountAmount, netTotal)
VALUES (1, '2025-07-19 16:01:20', 'Cancelled', 103, 40.0, NULL, 0.0, 40.0);

-------------------
insert into payments values(25,'cash',50,'2025-07-19');

drop trigger trg_FillDiscountAmountnew6;
INSERT INTO OrderDetails (orderID, productID, quantity, discountID)
VALUES (25, 3, 3, 4);
SELECT * FROM employee ;
SELECT * FROM OrderDetails  ;
SELECT * FROM [Order] WHERE orderID=2 ;
SELECT * FROM discountDetails  ;
SELECT * FROM discountPermissions  ;
SELECT * FROM [Order];
SELECT * FROM [Order] WHERE orderID=1 ;
SELECT * FROM discountDetails  ;
SELECT * FROM discountPermissions  ;
SELECT * FROM systemSettings  ;
SELECT * FROM payments  ;
SELECT * FROM products;
SELECT * FROM OrderDetails  ;
select top  1 p.ProductName, count(od.productID)as count from OrderDetails as od join products as p on od.productID=p.ProductID 
group by p.ProductName
order by count(od.productID)desc;
select top 1 orderid, netTotal from [order] order by netTotal desc;
select orderid  from [order]where discountid is not null;
select top 1   e.firstName ,count(o.orderID)  from [order] as o join employee as e on o.employeeID=e.employeeID group by e.firstName order by count(o.orderID)  desc ;
select c.firstName,count(o.orderID) from [order] as o inner join customer as c on o.customerID=c.customerID group by c.firstName;
select orderID,count(productID) from OrderDetails group by orderID  having count(distinct productID)>3 ;
select c.firstName , sum(o.netTotal) from [order] as o join customer as c on o.customerID=c.customerID group by  c.firstName;
select p.ProductID, p.ProductName from products as p where not exists(
select 1  from OrderDetails od where od.productID = p.ProductID 
) ;

select * from [order] where netTotal>50;
select c.firstName,(orderDate) from [order] as o join customer as c on o.customerID=c.customerID  ;

select p.ProductName,COUNT(od.productID) from OrderDetails as od join products as p on od.productID=p.ProductID group by  p.ProductName limit ;
select p.ProductName from OrderDetails  as od join products as p on  od.productID= p.ProductID where od.discountID is not null GROUP BY p.ProductName
having count(p.productID )<5;
SELECT DISTINCT p.ProductName
FROM OrderDetails od
JOIN Products p ON od.ProductID = p.ProductID
JOIN [Order] o ON od.OrderID = o.OrderID
WHERE o.orderDate BETWEEN '2025-07-01' AND '2025-07-21';



truncate table orderdetails;
--حذف كل التريغرز
DECLARE @name NVARCHAR(100)
DECLARE cur CURSOR FOR
SELECT name FROM sys.triggers WHERE parent_class_desc = 'OBJECT_OR_COLUMN'

OPEN cur
FETCH NEXT FROM cur INTO @name

WHILE @@FETCH_STATUS = 0
BEGIN
    EXEC('DROP TRIGGER [' + @name + ']')
    FETCH NEXT FROM cur INTO @name
END

CLOSE cur
DEALLOCATE cur

SELECT * FROM sys.triggers






 -----------not
 CREATE TRIGGER trg_FillDiscountAmountnew5
ON OrderDetails
AFTER INSERT
AS
BEGIN
    UPDATE od
    SET od.DiscountAmount = 
        CASE 
            WHEN dd.valueType = 'percent' 
--THEN ((dd.value / 100.0) * (od.ProductPrice + (od.ProductPrice * od.ProductTax/100.0))) * od.quantity
THEN (dd.value / 100.0) * ((od.ProductPrice + (od.ProductPrice * ISNULL(od.ProductTax/100.0, 0))) * od.quantity)


            ELSE dd.value * od.quantity    
        END
    FROM OrderDetails od
    JOIN inserted i ON od.OrderDetailsID = i.OrderDetailsID
    JOIN discountDetails dd ON i.discountID = dd.discountID
    WHERE i.discountID IS NOT NULL;
END;
